#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий
// Процедура - обработчик события ОбработкаПроверкиЗаполнения объекта.
//
Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	Если ПолучитьФункциональнуюОпцию("ВестиУчетОСПоКомплектам") Тогда
		КонтрольПризнакаЭтоКомплект(Отказ);
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура КонтрольПризнакаЭтоКомплект(Отказ)
	Если ЭтоГруппа Тогда
		Возврат;
	КонецЕсли;
	
	Если ЭтоКомплект Тогда
		// Контроль - нельзя для комплектов использовать ОС оформленных в ПТМЗиУ
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СобытияОС.ОсновноеСредство КАК ОсновноеСредство
			|ИЗ
			|	РегистрСведений.СобытияОС КАК СобытияОС
			|ГДЕ
			|	СобытияОС.ОсновноеСредство = &Ссылка";
		
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			// Вставить обработку выборки ВыборкаДетальныеЗаписи
		КонецЦикла;
		
		Если ВыборкаДетальныеЗаписи.Следующий() Тогда
			ТекстСообщения = СтрШаблон(НСтр("ru = 'Установлен признак ""Это комплект"". Нельзя использовать ОС, оформленных в ПТМЗиУ, как комплекты.'"), 
				Ссылка, ВыборкаДетальныеЗаписи.ОсновноеСредство);		
			БухгалтерскийУчетСервер.СообщитьОбОшибке(
				ЭтотОбъект,   
				ТекстСообщения,
				,
				,
				,
				Отказ);		
		КонецЕсли;
		
		// Контроль - нельзя для комплектов использовать ОС, входящее/входившее в другой комплект
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СоставОССрезПоследних.ОсновноеСредство КАК ОсновноеСредство,
			|	СоставОССрезПоследних.ОсновноеСредствоВСоставеКомплекта КАК ОсновноеСредствоВСоставеКомплекта
			|ИЗ
			|	РегистрСведений.СоставОС.СрезПоследних(, ОсновноеСредствоВСоставеКомплекта = &Ссылка) КАК СоставОССрезПоследних
			|
			|СГРУППИРОВАТЬ ПО
			|	СоставОССрезПоследних.ОсновноеСредство,
			|	СоставОССрезПоследних.ОсновноеСредствоВСоставеКомплекта";
		
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Если ВыборкаДетальныеЗаписи.Следующий() Тогда
			ТекстСообщения = СтрШаблон(НСтр("ru = 'В Основное средство ""%1"" входило/входит в состав другого комплекта ""%2"". Признак ""Это комплект"" устанавливать нельзя.'"), 
				Ссылка, ВыборкаДетальныеЗаписи.ОсновноеСредство);		
			БухгалтерскийУчетСервер.СообщитьОбОшибке(
				ЭтотОбъект,   
				ТекстСообщения,
				,
				,
				,
				Отказ);		
		КонецЕсли;			
			
	Иначе
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СоставОССрезПоследних.ОсновноеСредство КАК ОсновноеСредство
			|ИЗ
			|	РегистрСведений.СоставОС.СрезПоследних(, ОсновноеСредство = &Ссылка) КАК СоставОССрезПоследних
			|
			|СГРУППИРОВАТЬ ПО
			|	СоставОССрезПоследних.ОсновноеСредство";
		
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Если ВыборкаДетальныеЗаписи.Следующий() Тогда
			ТекстСообщения = СтрШаблон(НСтр("ru = 'Основное средство ""%1"" нельзя записывать с выключенным признаком ""Это комплект"", т.к. это комплект и в него входило/входят другие ОС.'"), 
				Ссылка);		
			БухгалтерскийУчетСервер.СообщитьОбОшибке(
				ЭтотОбъект,   
				ТекстСообщения,
				,
				,
				,
				Отказ);		
		КонецЕсли;						
	
	КонецЕсли;	
		
КонецПроцедуры
	
#КонецОбласти

#Иначе
ВызватьИсключение НСтр("ru = 'Недопустимый вызов объекта на клиенте.'");
#КонецЕсли